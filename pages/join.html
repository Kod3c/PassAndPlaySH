<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Game - Secret Hitler</title>
    <meta name="description" content="Join an existing Secret Hitler game">
    <link rel="stylesheet" href="../styles/app.css">
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#101820">
</head>
<body>
    <div class="page-wrapper">
        <!-- Header -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <span class="logo-icon">ðŸŽ­</span>
                        <div class="logo-text">
                            <h1>Secret Hitler</h1>
                            <p class="subtitle">Join Game</p>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main>
            <div class="container">
                <div class="card mb-4">
                    <div class="card-header">
                        <span class="card-icon">ðŸ”—</span>
                        <div>
                            <h2 class="card-title">Join Game</h2>
                            <p class="section-description">Enter your name to join the lobby</p>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="form-group">
                            <label class="form-label" for="player-name">Player Name</label>
                            <input id="player-name" class="form-control" type="text" placeholder="Your name" maxlength="24" autocomplete="name">
                        </div>
                        <div class="btn-group">
                            <button id="join-btn" class="btn btn-primary">Join Lobby</button>
                            <button class="btn btn-outline" onclick="window.location.href='../index.html'">Back to Home</button>
                        </div>
                        <div id="join-status" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="main-footer">
            <div class="container">
                <div class="footer-content">
                    <p class="footer-text">Built for offline play - no accounts or servers required</p>
                    <div class="footer-links">
                        <a href="../pages/rules.html" class="footer-link">ðŸ“– Rules</a>
                        <span class="footer-separator">â€¢</span>
                        <a href="../index.html" class="footer-link">ðŸŽ® Play</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script type="module">
        import { app } from '../js/firebase.js';
        import { getFirestore, doc, collection, addDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

        const db = getFirestore(app);

        function getGameId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('game') || '';
        }

        async function ensureAuth() {
            const auth = getAuth(app);
            if (!auth.currentUser) await signInAnonymously(auth);
            return auth.currentUser;
        }

        async function addPlayer(gameId, name) {
            const gameRef = doc(db, 'games', gameId);
            const gameSnap = await getDoc(gameRef);
            if (!gameSnap.exists()) throw new Error('Game not found');
            const col = collection(gameRef, 'players');
            await addDoc(col, { name: name.trim(), alive: true, createdAt: serverTimestamp() });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const joinBtn = document.getElementById('join-btn');
            const nameInput = document.getElementById('player-name');
            const status = document.getElementById('join-status');
            const gameId = getGameId();
            if (!gameId) {
                status.textContent = 'Missing game ID in URL.';
                joinBtn.disabled = true;
                return;
            }

            joinBtn.addEventListener('click', async function() {
                const name = (nameInput.value || '').trim();
                if (!name) {
                    status.textContent = 'Please enter your name.';
                    return;
                }
                joinBtn.disabled = true;
                status.textContent = 'Joining...';
                try {
                    await ensureAuth();
                    await addPlayer(gameId, name);
                    status.textContent = 'Joined! Redirecting to lobby...';
                    setTimeout(() => { window.location.href = `./lobby.html?game=${encodeURIComponent(gameId)}`; }, 600);
                } catch (e) {
                    console.error(e);
                    status.textContent = 'Failed to join. Check the link and try again.';
                    joinBtn.disabled = false;
                }
            });
        });
    </script>
</body>
</html>
