<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Game - Secret Hitler</title>
    <meta name="description" content="Join an existing Secret Hitler game">
    <link rel="stylesheet" href="../styles/app.css?v=dev">
    <link rel="manifest" href="../manifest.json?v=dev">
    <meta name="theme-color" content="#101820">
</head>
<body>
    <div class="page-wrapper">
        <!-- Header -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo" onclick="window.location.href='../index.html'">
                        <span class="logo-icon">ðŸŽ­</span>
                        <div class="logo-text">
                            <h1>Secret Hitler</h1>
                            <p class="subtitle">Join Game</p>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main>
            <div class="container">
                <div class="card mb-4">
                    <div class="card-header">
                        <span class="card-icon">ðŸ”—</span>
                        <div>
                            <h2 class="card-title">Join Game</h2>
                            <p class="section-description">Enter your name to join the lobby</p>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="form-group">
                            <label class="form-label" for="game-id">Game ID</label>
                            <input id="game-id" class="form-control" type="text" placeholder="e.g. SH325-IK5L" maxlength="16" autocomplete="off">
                            <small class="form-help">Paste or type the game code</small>
                        </div>

                        <div id="game-status" class="mt-2" style="margin-bottom: 1rem;"></div>

                        <div class="form-group">
                            <label class="form-label" for="player-name">Player Name</label>
                            <input id="player-name" class="form-control" type="text" placeholder="Your name" maxlength="24" autocomplete="name" list="existing-names">
                            <datalist id="existing-names"></datalist>
                            <small class="form-help">Current players will show as suggestions</small>
                        </div>
                        <div class="btn-group">
                            <button id="join-btn" class="btn btn-primary">Join Lobby</button>
                            <button class="btn btn-outline" onclick="window.location.href='../index.html'">Back to Home</button>
                        </div>
                        <div id="join-status" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="main-footer">
            <div class="container">
                <div class="footer-content">
                    <p class="footer-text">Built for offline play - no accounts or servers required</p>
                    <div class="footer-links">
                        <a href="../pages/rules.html" class="footer-link">ðŸ“– Rules</a>
                        <span class="footer-separator">â€¢</span>
                        <a href="../index.html" class="footer-link">ðŸŽ® Play</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script type="module">
        import { app } from '../js/firebase.js';
        import { getFirestore, doc, collection, serverTimestamp, getDoc, setDoc, query, getDocs, where, updateDoc, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

        const db = getFirestore(app);

        function getGameIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('game') || '';
        }

        function normalizeGameId(id) {
            return (id || '').trim().toUpperCase();
        }

        async function ensureAuth() {
            const auth = getAuth(app);
            if (!auth.currentUser) await signInAnonymously(auth);
            return auth.currentUser;
        }

        async function claimOrAddPlayer(gameId, name, uid) {
            const gameRef = doc(db, 'games', gameId);
            const gameSnap = await getDoc(gameRef);
            if (!gameSnap.exists()) throw new Error('Game not found');
            const playersCol = collection(gameRef, 'players');

            // Only allow joining with an existing player name; do not auto-create
            const q = query(playersCol, where('name', '==', name.trim()));
            const snap = await getDocs(q);
            if (snap.empty) {
                throw new Error('Player name not found in this game');
            }

            let claimedPlayerId = null;
            for (const d of snap.docs) {
                const data = d.data() || {};
                if (data.uid === uid) {
                    await updateDoc(d.ref, { lastSeen: serverTimestamp() });
                    claimedPlayerId = d.id;
                    break;
                }
                if (!data.uid) {
                    await updateDoc(d.ref, { uid, lastSeen: serverTimestamp() });
                    claimedPlayerId = d.id;
                    break;
                }
            }

            if (!claimedPlayerId) {
                throw new Error('That name is already taken');
            }

            // Extend TTL by 15 minutes when a player joins/claims
            await setDoc(gameRef, { updatedAt: serverTimestamp(), expireAt: new Date(Date.now() + 15 * 60 * 1000) }, { merge: true });

            // Persist for lobby heartbeat
            try { localStorage.setItem(`sh_playerId_${gameId}`, claimedPlayerId); } catch (_) {}
            return claimedPlayerId;
        }

        async function loadGameMeta(gameId) {
            const statusEl = document.getElementById('game-status');
            const datalist = document.getElementById('existing-names');
            datalist.innerHTML = '';
            if (!gameId) {
                statusEl.textContent = '';
                return null;
            }
            const gameRef = doc(db, 'games', gameId);
            const snap = await getDoc(gameRef);
            if (!snap.exists()) {
                statusEl.textContent = 'Game not found.';
                return null;
            }
            const game = snap.data();
            statusEl.textContent = `Found game: ${game.name || gameId} (${gameId})`;
            const playersSnap = await getDocs(query(collection(gameRef, 'players'), orderBy('createdAt', 'asc')));
            const names = playersSnap.docs.map(d => (d.data().name || '').toString());
            names.forEach(n => {
                if (!n) return;
                const opt = document.createElement('option');
                opt.value = n;
                datalist.appendChild(opt);
            });
            try { localStorage.setItem('sh_currentGameId', gameId); } catch (_) {}
            return game;
        }

        document.addEventListener('DOMContentLoaded', function() {
            const joinBtn = document.getElementById('join-btn');
            const nameInput = document.getElementById('player-name');
            const status = document.getElementById('join-status');
            const gameIdInput = document.getElementById('game-id');

            let currentGameId = normalizeGameId(getGameIdFromUrl());
            if (currentGameId) {
                gameIdInput.value = currentGameId;
                loadGameMeta(currentGameId);
            }

            function updateJoinEnabled() {
                const name = (nameInput.value || '').trim();
                const gid = normalizeGameId(gameIdInput.value);
                joinBtn.disabled = !(name && gid);
            }

            let debounceTimer = null;
            gameIdInput.addEventListener('input', function() {
                const gid = normalizeGameId(gameIdInput.value);
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => { loadGameMeta(gid); }, 250);
                updateJoinEnabled();
            });

            nameInput.addEventListener('input', updateJoinEnabled);
            updateJoinEnabled();

            joinBtn.addEventListener('click', async function() {
                const name = (nameInput.value || '').trim();
                const gid = normalizeGameId(gameIdInput.value);
                if (!name || !gid) return;
                joinBtn.disabled = true;
                status.textContent = 'Joining...';
                try {
                    const user = await ensureAuth();
                    await claimOrAddPlayer(gid, name, user.uid);
                    status.textContent = 'Joined! Redirecting to lobby...';
                    setTimeout(() => { window.location.href = `./lobby.html?game=${encodeURIComponent(gid)}`; }, 600);
                } catch (e) {
                    console.error(e);
                    status.textContent = (e && e.message) ? e.message : 'Failed to join. Check the Game ID and try again.';
                    joinBtn.disabled = false;
                }
            });
        });
    </script>
</body>
</html>
