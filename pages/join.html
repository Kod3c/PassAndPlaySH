<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Game - Secret Hitler</title>
    <meta name="description" content="Join an existing Secret Hitler game">
    <link rel="stylesheet" href="../styles/app.css?v=dev">
    <link rel="manifest" href="../manifest.json?v=dev">
    <meta name="theme-color" content="#101820">
</head>
<body>
    <div class="page-wrapper">
        <!-- Header -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo" onclick="window.location.href='../index.html'">
                        <span class="logo-icon">ðŸŽ­</span>
                        <div class="logo-text">
                            <h1>Secret Hitler</h1>
                            <p class="subtitle">Join Game</p>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main>
            <div class="container">
                <div class="card mb-4">
                    <div class="card-header">
                        <span class="card-icon">ðŸ”—</span>
                        <div>
                            <h2 class="card-title">Join Game</h2>
                            <p class="section-description">Enter your name to join the lobby</p>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="form-group">
                            <label class="form-label" for="game-id">Game ID</label>
                            <input id="game-id" class="form-control" type="text" placeholder="e.g. SH325-IK5L" maxlength="16" autocomplete="off">
                            <small class="form-help">Paste or type the game code</small>
                        </div>

                        <div id="game-status" class="mt-2" style="margin-bottom: 1rem;"></div>

                        <div class="form-group">
                            <label class="form-label" for="player-name">Player Name</label>
                            <input id="player-name" class="form-control" type="text" placeholder="Your name" maxlength="24" autocomplete="name" list="existing-names">
                            <datalist id="existing-names"></datalist>
                            <select id="player-name-select" class="form-control" style="display:none"></select>
                            <small class="form-help">Choose your name from the roster when a valid Game ID is entered</small>
                        </div>
                        <div class="btn-group">
                            <button id="join-btn" class="btn btn-primary">Join Lobby</button>
                            <button class="btn btn-outline" onclick="window.location.href='../index.html'">Back to Home</button>
                        </div>
                        <div id="join-status" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="main-footer">
            <div class="container">
                <div class="footer-content">
                    <p class="footer-text">Built for offline play - no accounts or servers required</p>
                    <div class="footer-links">
                        <a href="../pages/rules.html" class="footer-link">ðŸ“– Rules</a>
                        <span class="footer-separator">â€¢</span>
                        <a href="../index.html" class="footer-link">ðŸŽ® Play</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script type="module">
        import { app } from '../js/firebase.js';
        import { getFirestore, doc, collection, serverTimestamp, getDoc, setDoc, query, getDocs, where, updateDoc, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

        const db = getFirestore(app);

        function getGameIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('game') || '';
        }

        function normalizeGameId(id) {
            // Allow only A-Z, 0-9, and one hyphen separator
            const upper = (id || '').toUpperCase();
            const cleaned = upper.replace(/[^A-Z0-9-]/g, '');
            // Collapse multiple hyphens to a single and trim hyphen ends
            const collapsed = cleaned.replace(/-+/g, '-').replace(/^-+/, '').replace(/-+$/, '');
            // Limit length to 16
            return collapsed.slice(0, 16);
        }

        async function ensureAuth() {
            const auth = getAuth(app);
            if (!auth.currentUser) await signInAnonymously(auth);
            return auth.currentUser;
        }

        async function claimOrAddPlayer(gameId, name, uid) {
            const gameRef = doc(db, 'games', gameId);
            const gameSnap = await getDoc(gameRef);
            if (!gameSnap.exists()) throw new Error('Game not found');
            const playersCol = collection(gameRef, 'players');

            // Only allow joining with an existing player name; do not auto-create
            const q = query(playersCol, where('name', '==', name.trim()));
            const snap = await getDocs(q);
            if (snap.empty) {
                throw new Error('Player name not found in this game');
            }

            let claimedPlayerId = null;
            for (const d of snap.docs) {
                const data = d.data() || {};
                if (data.uid === uid) {
                    await updateDoc(d.ref, { lastSeen: serverTimestamp() });
                    claimedPlayerId = d.id;
                    break;
                }
                if (!data.uid) {
                    await updateDoc(d.ref, { uid, lastSeen: serverTimestamp() });
                    claimedPlayerId = d.id;
                    break;
                }
            }

            if (!claimedPlayerId) {
                throw new Error('That name is already taken');
            }

            // Extend TTL by 15 minutes when a player joins/claims
            await setDoc(gameRef, { updatedAt: serverTimestamp(), expireAt: new Date(Date.now() + 15 * 60 * 1000) }, { merge: true });

            // Persist for lobby heartbeat (per-tab)
            try { sessionStorage.setItem(`sh_playerId_${gameId}`, claimedPlayerId); } catch (_) {}
            return claimedPlayerId;
        }

        async function loadGameMeta(gameId) {
            const statusEl = document.getElementById('game-status');
            const datalist = document.getElementById('existing-names');
            const nameInput = document.getElementById('player-name');
            const nameSelect = document.getElementById('player-name-select');
            datalist.innerHTML = '';
            if (!gameId) {
                statusEl.textContent = '';
                // Revert to free text when no game
                if (nameSelect) { nameSelect.style.display = 'none'; nameSelect.innerHTML = ''; }
                if (nameInput) { nameInput.style.display = ''; nameInput.value = ''; }
                return null;
            }
            const gameRef = doc(db, 'games', gameId);
            const snap = await getDoc(gameRef);
            if (!snap.exists()) {
                statusEl.textContent = 'Game not found.';
                if (nameSelect) { nameSelect.style.display = 'none'; nameSelect.innerHTML = ''; }
                if (nameInput) { nameInput.style.display = ''; }
                return null;
            }
            const game = snap.data();
            statusEl.textContent = `Found game: ${game.name || gameId} (${gameId})`;
            const playersSnap = await getDocs(query(collection(gameRef, 'players'), orderBy('createdAt', 'asc')));
            // Read host pass requirement from game
            const hostPasswordHash = (snap.data() && snap.data().hostPasswordHash) || null;
            // Determine availability per name (uid present => unavailable)
            let currentUser = null;
            try { currentUser = await ensureAuth(); } catch (_) { currentUser = null; }
            const nameInfo = new Map();
            playersSnap.docs.forEach(d => {
                const data = d.data() || {};
                const n = (data.name || '').toString().trim();
                if (!n) return;
                const uid = data.uid || null;
                let info = nameInfo.get(n);
                if (!info) {
                    info = { name: n, unclaimed: 0, claimed: false };
                    nameInfo.set(n, info);
                }
                if (!uid) info.unclaimed += 1;
                else info.claimed = true;
            });

            // Populate dropdown and datalist with optgroups
            if (nameSelect) { nameSelect.innerHTML = ''; }
            datalist.innerHTML = '';

            const allNames = Array.from(nameInfo.values()).map(i => i.name).sort((a,b) => a.localeCompare(b));
            allNames.forEach(n => {
                const opt = document.createElement('option');
                opt.value = n;
                datalist.appendChild(opt);
            });

            if (nameSelect) {
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = 'Select your name';
                placeholder.disabled = true;
                placeholder.selected = true;
                nameSelect.appendChild(placeholder);

                const availableGroup = document.createElement('optgroup');
                availableGroup.label = 'Available';
                const unavailableGroup = document.createElement('optgroup');
                unavailableGroup.label = 'Unavailable';

                const availableNames = [];
                const unavailableNames = [];
                nameInfo.forEach(info => {
                    const available = info.unclaimed > 0;
                    (available ? availableNames : unavailableNames).push(info);
                });
                availableNames.sort((a,b) => a.name.localeCompare(b.name));
                unavailableNames.sort((a,b) => a.name.localeCompare(b.name));

                availableNames.forEach(info => {
                    const o = document.createElement('option');
                    o.value = info.name;
                    o.textContent = info.name;
                    availableGroup.appendChild(o);
                });
                unavailableNames.forEach(info => {
                    const o = document.createElement('option');
                    o.value = info.name;
                    o.textContent = info.name + ' - Unavailable';
                    o.disabled = true;
                    unavailableGroup.appendChild(o);
                });

                if (availableNames.length) nameSelect.appendChild(availableGroup);
                if (unavailableNames.length) nameSelect.appendChild(unavailableGroup);

                // If exactly one name is available, auto-select it
                if (availableNames.length === 1) {
                    nameSelect.value = availableNames[0].name;
                    try { nameSelect.dispatchEvent(new Event('change')); } catch (_) {}
                }
            }

            // Switch to dropdown mode
            if (nameInput) nameInput.style.display = 'none';
            if (nameSelect) nameSelect.style.display = '';

            // Ensure Join button state reflects current selection
            const joinBtnEl = document.getElementById('join-btn');
            if (joinBtnEl) {
                const usingSelect = nameSelect && nameSelect.style.display !== 'none';
                const selectedValid = usingSelect
                    ? (nameSelect.value && nameSelect.selectedOptions.length && !nameSelect.selectedOptions[0].disabled)
                    : Boolean(nameInput && (nameInput.value || '').trim());
                joinBtnEl.disabled = !(selectedValid && !!gameId);
            }
            try { localStorage.setItem('sh_currentGameId', gameId); } catch (_) {}
            return game;
        }

        document.addEventListener('DOMContentLoaded', function() {
            const joinBtn = document.getElementById('join-btn');
            const nameInput = document.getElementById('player-name');
            const nameSelect = document.getElementById('player-name-select');
            const status = document.getElementById('join-status');
            const gameIdInput = document.getElementById('game-id');

            let currentGameId = normalizeGameId(getGameIdFromUrl());
            if (currentGameId) {
                gameIdInput.value = currentGameId;
                loadGameMeta(currentGameId);
            }

            function getSelectedName() {
                if (nameSelect && nameSelect.style.display !== 'none') {
                    const val = (nameSelect.value || '').trim();
                    if (val === '' || nameSelect.selectedOptions.length === 0 || nameSelect.selectedOptions[0].disabled) return '';
                    return val;
                }
                return (nameInput.value || '').trim();
            }

            function updateJoinEnabled() {
                const name = getSelectedName();
                const gid = normalizeGameId(gameIdInput.value);
                joinBtn.disabled = !(name && gid);
            }

            let debounceTimer = null;
            gameIdInput.addEventListener('input', function() {
                const gid = normalizeGameId(gameIdInput.value);
                // reflect sanitized value back to field for clarity
                gameIdInput.value = gid;
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => { loadGameMeta(gid); }, 250);
                updateJoinEnabled();
            });

            nameInput.addEventListener('input', updateJoinEnabled);
            if (nameSelect) nameSelect.addEventListener('change', updateJoinEnabled);
            if (nameSelect) nameSelect.addEventListener('input', updateJoinEnabled);
            updateJoinEnabled();

            joinBtn.addEventListener('click', async function() {
                const name = getSelectedName();
                const gid = normalizeGameId(gameIdInput.value);
                if (!name || !gid) return;
                joinBtn.disabled = true;
                status.textContent = 'Joining...';
                try {
                    const user = await ensureAuth();
                    // If attempting to join as host seat, and a password is set, prompt for it
                    const gameRef = doc(db, 'games', gid);
                    const gameSnap = await getDoc(gameRef);
                    const hostPass = gameSnap.exists() ? (gameSnap.data().hostPasswordHash || null) : null;
                    if (hostPass) {
                        // Find if selected name is host (seat 1)
                        const hostPlayersSnap = await getDocs(query(collection(gameRef, 'players'), where('seat', '==', 1)));
                        let hostName = null;
                        let hostDocRef = null;
                        hostPlayersSnap.forEach(d => { const data = d.data() || {}; hostName = hostName || (data.name || null); if (!hostDocRef) hostDocRef = d.ref; });
                        if (hostName && name === hostName) {
                            const input = window.prompt('Enter host password to reclaim host:');
                            const hash = input ? await crypto.subtle.digest('SHA-256', new TextEncoder().encode(input)).then(buf => Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('')).catch(() => null) : null;
                            if (!hash || hash !== hostPass) throw new Error('Incorrect host password');
                            // Password verified: transfer host seat to this device's UID
                            if (hostDocRef) {
                                await updateDoc(hostDocRef, { uid: user.uid, lastSeen: serverTimestamp() });
                            }
                        }
                    }
                    await claimOrAddPlayer(gid, name, user.uid);
                    status.textContent = 'Joined! Redirecting to lobby...';
                    setTimeout(() => { window.location.href = `./lobby.html?game=${encodeURIComponent(gid)}`; }, 600);
                } catch (e) {
                    console.error(e);
                    status.textContent = (e && e.message) ? e.message : 'Failed to join. Check the Game ID and try again.';
                    joinBtn.disabled = false;
                }
            });
        });
    </script>
</body>
</html>
