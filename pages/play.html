<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play - Secret Hitler</title>
    <link rel="stylesheet" href="../styles/app.css">
    <meta name="theme-color" content="#101820">
    <style>
        :root {
            --liberal-blue: #00AEEF;
            --fascist-red: #DA291C;
            --propaganda-black: #101820;
            --neutral-beige: #D6C6A9;
            --highlight-cream: #F1E6B2;
        }
        .play-wrapper { display:flex; flex-direction:column; min-height:100vh; background: var(--neutral-beige); }
        .play-main { flex:1; display:flex; align-items:center; justify-content:center; padding: 12px 12px 96px; }
        .board-shell { width: 100%; max-width: 1040px; display:flex; flex-direction:column; align-items:center; gap: 12px; }
        .players-strip { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; }
        .player-chip { padding: 4px 10px; border: 2px solid var(--propaganda-black); background:#fff; font-weight:700; }
        .player-chip.is-president { background: #fef3c7; }
        .player-chip.is-chancellor { background: #e0f2fe; }
        .board-area { width:100%; display:flex; flex-direction:column; gap:12px; }
        .board-frame { width:100%; border: 6px solid var(--propaganda-black); border-radius: 12px; background: #f6f0df; box-shadow: 0 10px 30px rgba(0,0,0,0.25), inset 0 0 0 4px var(--highlight-cream); padding: 16px; }
        .tracks { display:grid; grid-template-columns: 1fr; gap: 16px; }
        .track { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px; border: 3px solid var(--propaganda-black); background: var(--neutral-beige); box-shadow: inset 0 0 0 3px rgba(0,0,0,0.15); border-radius: 8px; }
        .track.liberal { background: var(--liberal-blue); color: #fff; }
        .track.fascist { background: var(--fascist-red); color: #fff; }
        .track-title { font-weight:900; letter-spacing:0.04em; }
        .slots { display:flex; gap:8px; align-items:center; }
        .slot { width: 50px; height: 68px; border: 3px solid #000; background: rgba(255,255,255,0.18); box-shadow: inset 0 0 0 3px rgba(241,230,178,0.9); border-radius: 4px; }
        .tracker { display:flex; align-items:center; gap:10px; justify-content:center; padding-top: 4px; }
        .tracker-row { display:flex; align-items:center; justify-content:center; gap:10px; padding-top: 4px; }
        .tracker-label { font-weight:900; letter-spacing: 0.02em; }
        .tracker .bubble { width:26px; height:26px; border-radius:50%; background:#fff; border:3px solid var(--propaganda-black); }
        .tracker .square { width:26px; height:26px; border-radius:4px; background:#fff; border:3px solid var(--propaganda-black); display:inline-flex; align-items:center; justify-content:center; font-weight:900; }
        .tracker .square.active { background: var(--highlight-cream); }
        .policy-summary { display:flex; align-items:stretch; justify-content:center; gap:10px; margin-top: 8px; }
        .policy-card-wrap { display:flex; flex-direction:column; align-items:center; }
        .policy-card-title { display:none; font-weight:900; margin-bottom: 4px; letter-spacing:0.02em; }
        .policy-chip { padding: 6px 10px; border: 3px solid var(--propaganda-black); background:#fff; font-weight:800; box-shadow: inset 0 0 0 3px rgba(241,230,178,0.6); }
        .policy-chip.liberal { background: var(--liberal-blue); color:#fff; }
        .policy-chip.fascist { background: var(--fascist-red); color:#fff; }
        .policy-chip .count { margin-left: 6px; font-weight: 900; }
        @media (max-width: 640px) {
            .policy-summary { flex-direction: column; align-items: center; gap: 12px; }
            .policy-card-title { display:block; }
        }
        .floating-footer { position: fixed; left: 0; right: 0; bottom: calc(12px + env(safe-area-inset-bottom)); padding: 0 12px; z-index: 50; pointer-events: none; }
        .actions-bar { pointer-events: auto; max-width: 960px; margin: 0 auto; display:flex; align-items:center; justify-content:space-between; gap:8px; padding: 10px 12px; background: rgba(255,255,255,0.95); border: 3px solid var(--propaganda-black); border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.25); }
        .actions-left, .actions-center, .actions-right { display:flex; gap:8px; align-items:center; }
        .btn { cursor:pointer; border: 3px solid var(--propaganda-black); background:#fff; padding: 8px 12px; font-weight:800; letter-spacing: 0.02em; }
        .btn-primary { background: var(--highlight-cream); }
        .status-banner { text-align:center; font-weight:800; }
        /* Floating role banner */
        .floating-role { position: fixed; left: 0; right: 0; top: 0; padding: 0 12px; z-index: 2000; pointer-events: none; display:none; }
        .role-bar { pointer-events: auto; max-width: 960px; margin: 0 auto; display:flex; align-items:center; justify-content:center; gap:10px; padding: 10px 14px; background: var(--off-white); border: 4px solid var(--propaganda-black); border-radius: 12px; box-shadow: var(--shadow-lg); font-weight: 900; font-family: var(--font-propaganda); text-transform: uppercase; letter-spacing: 0.05em; animation: dropIn 180ms ease-out; }
        .role-tag { padding: 4px 10px; border: 3px solid var(--propaganda-black); background: var(--highlight-cream); box-shadow: inset 0 0 0 3px rgba(0,0,0,0.05); }
        .role-tag.pres { background: #fef3c7; }
        .role-tag.chanc { background: #e0f2fe; }
        @keyframes dropIn { from { transform: translateY(-8px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display:none; align-items: center; justify-content:center; z-index: 60; }
        .modal-card { width: min(720px, 92vw); background: #fff; border: 4px solid var(--propaganda-black); border-radius: 12px; box-shadow: 0 12px 32px rgba(0,0,0,0.35); }
        .modal-header { display:flex; align-items:center; justify-content:space-between; padding: 10px 12px; border-bottom: 3px solid var(--propaganda-black); }
        .modal-title { font-weight: 900; }
        .modal-body { padding: 12px; }
        .order-list { display:flex; flex-direction:column; gap:8px; }
        .order-item { display:flex; align-items:center; justify-content:space-between; gap:8px; padding: 8px 10px; border: 2px dashed var(--propaganda-black); background:#fff; }
        .order-left { display:flex; align-items:center; gap:10px; }
        .order-num { width: 28px; height: 28px; border-radius: 50%; display:inline-flex; align-items:center; justify-content:center; border: 3px solid var(--propaganda-black); font-weight:900; background: var(--highlight-cream); }
        .badge-pres { padding: 2px 8px; background:#fef3c7; border:2px solid var(--propaganda-black); font-weight:800; }
        .badge-chanc { padding: 2px 8px; background:#e0f2fe; border:2px solid var(--propaganda-black); font-weight:800; }
        @media (min-width: 720px) {
            .tracks { grid-template-columns: 1fr; }
        }
    </style>
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#101820">
</head>
<body>
    <div class="play-wrapper">
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo" onclick="window.location.href='../index.html'">
                        <span class="logo-icon">ðŸŽ­</span>
                        <div class="logo-text">
                            <h1>Secret Hitler</h1>
                            <p class="subtitle">Game</p>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="play-main">
            <div class="board-shell">
                <div id="status" class="status-banner">Setting up gameâ€¦</div>
                <div id="players-strip" class="players-strip"></div>
                <div class="board-area">
                    <div class="board-frame">
                        <div class="tracks">
                            <section class="track liberal">
                                <div class="track-title">Liberal Policies</div>
                                <div class="slots" id="liberal-slots"></div>
                            </section>
                            <section class="track fascist">
                                <div class="track-title">Fascist Policies</div>
                                <div class="slots" id="fascist-slots"></div>
                            </section>
                        </div>
                        <div class="policy-summary">
                            <div class="policy-card-wrap">
                                <div class="policy-card-title">Liberal Policies</div>
                                <div class="policy-chip liberal">Liberal <span class="count" id="liberal-count">0/5</span></div>
                            </div>
                            <div class="policy-card-wrap">
                                <div class="policy-card-title">Fascist Policies</div>
                                <div class="policy-chip fascist">Fascist <span class="count" id="fascist-count">0/6</span></div>
                            </div>
                        </div>
                        <div class="tracker-row">
                            <div class="tracker-label">Failed Elections</div>
                            <div class="tracker" id="election-tracker"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="floating-footer">
            <div class="actions-bar">
                <div class="actions-left">
                    <button id="menu-btn" class="btn">â˜° Menu</button>
                    <button id="help-btn" class="btn">ðŸ“– Rules</button>
                </div>
                <div class="actions-center">
                </div>
                <div class="actions-right">
                    <button id="history-btn" class="btn">ðŸ•’ History</button>
                    <button id="order-btn" class="btn">ðŸ‘¥ Order</button>
                </div>
            </div>
        </footer>
        <div id="role-banner" class="floating-role" style="top: calc(80px + env(safe-area-inset-top));">
            <div class="role-bar"><span id="role-badge" class="role-tag"></span></div>
        </div>
        <div id="order-modal" class="modal-overlay">
            <div class="modal-card">
                <div class="modal-header">
                    <div class="modal-title">Player Order</div>
                    <button id="order-close" class="btn">âœ–</button>
                </div>
                <div id="order-body" class="modal-body"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { app } from '../js/firebase.js';
        import { getFirestore, doc, getDoc, onSnapshot, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

        const db = getFirestore(app);
        let latestGame = null;
        let latestPlayers = [];

        function getGameId() {
            const p = new URLSearchParams(window.location.search);
            return p.get('game') || localStorage.getItem('sh_currentGameId') || '';
        }

        function getYouPlayerId(gameId) {
            try { return sessionStorage.getItem(`sh_playerId_${gameId}`) || null; } catch (_) { return null; }
        }

        async function ensureAuth() {
            const auth = getAuth(app);
            if (!auth.currentUser) {
                try { await signInAnonymously(auth); } catch (_) {}
            }
            return auth.currentUser;
        }

        function computeYouId(gameId) {
            const fromSession = getYouPlayerId(gameId);
            if (fromSession) return fromSession;
            const auth = getAuth(app);
            const uid = auth && auth.currentUser ? auth.currentUser.uid : null;
            if (!uid) return null;
            const m = (latestPlayers || []).find(p => p && p.uid === uid);
            return m ? m.id : null;
        }

        function renderSlots(el, count) {
            el.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const s = document.createElement('div');
                s.className = 'slot';
                el.appendChild(s);
            }
        }

        function renderTracker(el) {
            el.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const b = document.createElement('div');
                b.className = 'square';
                b.textContent = String(i + 1);
                b.dataset.index = String(i);
                el.appendChild(b);
            }
        }

        function updateFromGame(game) {
            if (!game) return;
            const lib = Number(game.liberalPolicies || 0);
            const fas = Number(game.fascistPolicies || 0);
            const et = Number(game.electionTracker || 0);

            const libEl = document.getElementById('liberal-count');
            const fasEl = document.getElementById('fascist-count');
            if (libEl) libEl.textContent = `${lib}/5`;
            if (fasEl) fasEl.textContent = `${fas}/6`;

            const squares = document.querySelectorAll('#election-tracker .square');
            squares.forEach((sq, idx) => {
                if (et > idx) sq.classList.add('active');
                else sq.classList.remove('active');
            });
        }

        function updateRoleBanner(game, gameId) {
            const banner = document.getElementById('role-banner');
            const badge = document.getElementById('role-badge');
            const youId = computeYouId(gameId);
            if (!banner || !badge || !game || !youId) { if (banner) banner.style.display = 'none'; return; }
            const isPres = game.currentPresidentPlayerId && (game.currentPresidentPlayerId === youId);
            const isChanc = game.currentChancellorPlayerId && (game.currentChancellorPlayerId === youId);
            if (!isPres && !isChanc) { banner.style.display = 'none'; return; }
            let text = '';
            let cls = 'role-tag';
            if (isPres && isChanc) { text = 'ðŸ‘‘ðŸ”¨ President & Chancellor'; }
            else if (isPres) { text = 'ðŸ‘‘ President'; cls += ' pres'; }
            else if (isChanc) { text = 'ðŸ”¨ Chancellor'; cls += ' chanc'; }
            badge.className = cls;
            badge.textContent = text;
            banner.style.display = 'block';
        }

        function renderPlayers(el, players) {
            el.innerHTML = '';
            (players || []).forEach(p => {
                const chip = document.createElement('div');
                chip.className = 'player-chip';
                const icons = [];
                if (p.isPresident) icons.push('ðŸ‘‘');
                if (p.isChancellor) icons.push('ðŸ”¨');
                const prefix = icons.length ? icons.join('') + ' ' : '';
                chip.textContent = prefix + (p.name || 'Player');
                if (p.isPresident) chip.classList.add('is-president');
                if (p.isChancellor) chip.classList.add('is-chancellor');
                el.appendChild(chip);
            });
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const gid = getGameId();
            // Ensure we have an auth user so we can match uid if session id missing
            await ensureAuth();
            const status = document.getElementById('status');
            const liberalSlots = document.getElementById('liberal-slots');
            const fascistSlots = document.getElementById('fascist-slots');
            const tracker = document.getElementById('election-tracker');
            const playersStrip = document.getElementById('players-strip');

            renderSlots(liberalSlots, 5);
            renderSlots(fascistSlots, 6);
            renderTracker(tracker);

            // Order modal handlers (set up early so button works even if game load fails)
            const orderBtn = document.getElementById('order-btn');
            const orderModal = document.getElementById('order-modal');
            const orderClose = document.getElementById('order-close');
            const orderBody = document.getElementById('order-body');

            function openOrderModal() {
                orderBody.innerHTML = '';
                const list = document.createElement('div');
                list.className = 'order-list';
                if (!latestPlayers || latestPlayers.length === 0) {
                    const p = document.createElement('p');
                    p.textContent = 'Player order not available yet.';
                    orderBody.appendChild(p);
                } else {
                    latestPlayers.forEach((p, idx) => {
                        const row = document.createElement('div');
                        row.className = 'order-item';
                        const left = document.createElement('div');
                        left.className = 'order-left';
                        const num = document.createElement('div');
                        num.className = 'order-num';
                        num.textContent = String(idx + 1);
                        const name = document.createElement('div');
                        name.style.fontWeight = '800';
                        name.textContent = p.name || 'Player';
                        left.appendChild(num);
                        left.appendChild(name);
                        row.appendChild(left);

                        const right = document.createElement('div');
                        if (latestGame && latestGame.currentPresidentPlayerId === p.id) {
                            const pres = document.createElement('span');
                            pres.className = 'badge-pres';
                            pres.textContent = 'ðŸ‘‘ President';
                            right.appendChild(pres);
                        }
                        if (latestGame && latestGame.currentChancellorPlayerId === p.id) {
                            const chanc = document.createElement('span');
                            chanc.className = 'badge-chanc';
                            chanc.textContent = 'ðŸ”¨ Chancellor';
                            right.appendChild(chanc);
                        }
                        row.appendChild(right);
                        list.appendChild(row);
                    });
                    orderBody.appendChild(list);
                }
                orderModal.style.display = 'flex';
            }

            function closeOrderModal() { orderModal.style.display = 'none'; }
            orderBtn?.addEventListener('click', openOrderModal);
            orderClose?.addEventListener('click', closeOrderModal);
            orderModal?.addEventListener('click', function(e) { if (e.target === orderModal) closeOrderModal(); });

            if (!gid) { status.textContent = 'Missing game id'; return; }

            const gameRef = doc(db, 'games', gid);
            const snap = await getDoc(gameRef);
            if (!snap.exists()) { status.textContent = 'Game not found'; return; }
            status.textContent = 'Game in progress';

            onSnapshot(gameRef, (s) => {
                latestGame = s.exists() ? s.data() : null;
                if (!latestGame) { status.textContent = 'Game unavailable'; return; }
                if (latestGame.state === 'cancelled') { status.textContent = 'Game cancelled'; }
                // Update player strip highlights if ids available
                renderPlayers(playersStrip, latestPlayers.map(p => ({
                    ...p,
                    isPresident: latestGame && (latestGame.currentPresidentPlayerId === p.id),
                    isChancellor: latestGame && (latestGame.currentChancellorPlayerId === p.id)
                })));
                // Update policy counters and election tracker if present
                updateFromGame(latestGame);
                // Update floating role banner for this device
                updateRoleBanner(latestGame, gid);
            });

            // Subscribe to players ordered by orderIndex
            onSnapshot(query(collection(db, 'games', gid, 'players'), orderBy('orderIndex', 'asc')), (snapColl) => {
                latestPlayers = snapColl.docs.map(d => ({ id: d.id, ...d.data() })) || [];
                renderPlayers(playersStrip, latestPlayers.map(p => ({
                    ...p,
                    isPresident: latestGame && (latestGame.currentPresidentPlayerId === p.id),
                    isChancellor: latestGame && (latestGame.currentChancellorPlayerId === p.id)
                })));
                // Also refresh the banner after players load (needed for uid->id map)
                updateRoleBanner(latestGame, gid);
            });

            document.getElementById('help-btn')?.addEventListener('click', function() {
                window.location.href = '../pages/rules.html';
            });

        });
    </script>
</body>
</html>


