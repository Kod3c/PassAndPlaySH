<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Hitler - Create Game</title>
    <link href="../styles/app.css" rel="stylesheet">
    <meta name="theme-color" content="#101820">
    <style>
        #duplicate-notice {
            border-left: 4px solid #00AEEF;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            box-shadow: 0 4px 12px rgba(0, 174, 239, 0.15);
        }
        #duplicate-notice .card-header {
            background: transparent;
        }
        #duplicate-notice .card-title {
            color: #0369a1;
        }
        #duplicate-notice .section-description {
            color: #0c4a6e;
        }
        .status-message.success {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
    
    
</head>
<body>
    <div class="page-wrapper">
        <!-- Header -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo" onclick="window.location.href='../index.html'">
                        <span class="logo-icon">üé≠</span>
                        <div class="logo-text">
                            <h1>Secret Hitler</h1>
                            <p class="subtitle">Game Setup</p>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main>
            <div class="container">
                <!-- Create Game Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <span class="card-icon">üéÆ</span>
                        <div>
                            <h2 class="card-title">Create New Game</h2>
                            <p class="section-description">Set up a new Secret Hitler game for your group</p>
                        </div>
                    </div>
                </div>

                <!-- Duplicate Game Notice -->
                <div id="duplicate-notice" class="card mb-4" style="display: none;">
                    <div class="card-header">
                        <span class="card-icon">üîÑ</span>
                        <div>
                            <h3 class="card-title">Duplicating Previous Game</h3>
                            <p class="section-description">The form below is pre-filled with players from your previous game. You can modify any details before creating the new game.</p>
                        </div>
                    </div>
                </div>

                <!-- Game Settings -->
                <div class="setup-section">
                    <div class="section-header">
                        <span class="section-icon">‚öôÔ∏è</span>
                        <h2 class="section-title">Game Settings</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-1 gap-3">
                        <div class="form-group">
                            <label for="game-name-input" class="form-label">Game Name</label>
                            <input type="text" id="game-name-input" class="form-control" placeholder="Enter game name" value="Secret Hitler">
                            <small class="form-help">Choose a memorable name for your game</small>
                        </div>
                        <div class="form-group">
                            <label for="host-password-input" class="form-label">Host Rejoin Password (optional)</label>
                            <input type="password" id="host-password-input" class="form-control" placeholder="Set a password to reclaim host if disconnected" maxlength="64" autocomplete="new-password">
                            <small class="form-help">If set, anyone joining as the host must enter this password.</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="game-mode-select" class="form-label">Game Mode</label>
                            <select id="game-mode-select" class="form-control" disabled>
                                <option value="standard" selected>Standard Game</option>
                                <option value="quick" disabled>Quick Game</option>
                                <option value="extended" disabled>Extended Game</option>
                            </select>
                            <small class="form-help">Standard: Full rules (other modes disabled)</small>
                        </div>
                    </div>
                </div>

                <!-- Player Count Section -->
                <div class="setup-section">
                    <div class="section-header">
                        <span class="section-icon">üë•</span>
                        <h2 class="section-title">Players</h2>
                    </div>
                    
                    <div class="player-count-controls">
                        <button class="count-btn" id="decrease-btn">‚àí</button>
                        <div class="player-count-display">
                            <span class="current-count">0</span>
                            <span>players</span>
                        </div>
                        <button class="count-btn" id="increase-btn">+</button>
                    </div>

                    <div id="player1-hint" class="create-game-hint hidden">üë§ Player 1 should be you (the person creating the game).</div>

                    <!-- Dynamic Player Name Inputs -->
                    <div id="player-inputs" class="player-inputs"></div>
                </div>

                <!-- Action Buttons -->
                <div class="btn-group flex justify-center gap-2 mt-4">
                    <button id="create-game-btn" class="btn btn-primary btn-lg">
                        <span>üöÄ</span>
                        <span>Create Game</span>
                    </button>
                    <button type="button" class="btn btn-outline btn-lg" onclick="window.history.back()">
                        <span>‚¨ÖÔ∏è</span>
                        <span>Back</span>
                    </button>
                </div>
            </div>
        </main>

        <!-- Status Messages Container -->
        <div id="status-container" class="status-container"></div>
    </div>

    <!-- JavaScript -->
    <script type="module">
        import { createGame } from '../js/db.js?v=2';
        // Player setup logic (skip 1-4 players, dynamic name inputs)
        document.addEventListener('DOMContentLoaded', function() {
            const increaseBtn = document.getElementById('increase-btn');
            const decreaseBtn = document.getElementById('decrease-btn');
            const currentCountSpan = document.querySelector('.current-count');
            const playerInputsContainer = document.getElementById('player-inputs');
            const createGameBtn = document.getElementById('create-game-btn');
            const player1Hint = document.getElementById('player1-hint');
            const gameNameInput = document.getElementById('game-name-input');
            const namesErrorId = 'names-error';

            const MIN_VALID_PLAYERS = 5;
            const MAX_PLAYERS = 10;
            
            // Store player names in memory to persist them when changing player count
            let playerNames = new Map();

            function updateControls(count) {
                if (decreaseBtn) decreaseBtn.disabled = count === 0;
                if (increaseBtn) increaseBtn.disabled = count === MAX_PLAYERS;
            }

            function renderPlayerInputs(count) {
                if (!playerInputsContainer) return;
                playerInputsContainer.innerHTML = '';
                for (let i = 1; i <= count; i++) {
                    const group = document.createElement('div');
                    group.className = 'player-input-group';

                    const label = document.createElement('label');
                    label.setAttribute('for', `player-name-${i}`);
                    label.textContent = `Player ${i}`;

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = `player-name-${i}`;
                    input.name = `player-name-${i}`;
                    input.className = 'form-control';
                    input.placeholder = 'Enter player name';
                    input.maxLength = 24;
                    input.autocomplete = 'name';
                    
                    // Restore saved name if it exists
                    if (playerNames.has(i)) {
                        input.value = playerNames.get(i);
                    }
                    
                    input.addEventListener('input', function() {
                        // Save name to memory as user types
                        playerNames.set(i, input.value);
                        validateForm();
                    });

                    group.appendChild(label);
                    group.appendChild(input);
                    playerInputsContainer.appendChild(group);
                }
                // Ensure error container exists right after inputs
                let err = document.getElementById(namesErrorId);
                if (!err) {
                    err = document.createElement('div');
                    err.id = namesErrorId;
                    err.className = 'form-error';
                    err.style.color = '#b91c1c';
                    err.style.fontWeight = '600';
                    err.style.marginTop = '0.5rem';
                    playerInputsContainer.parentElement.appendChild(err);
                }
            }

            function getPlayerCount() {
                return parseInt(currentCountSpan.textContent || '0', 10);
            }

            function setPlayerCount(newCount) {
                const oldCount = getPlayerCount();
                const bounded = Math.max(0, Math.min(MAX_PLAYERS, newCount));
                
                // Save current names before changing count
                if (oldCount > 0) {
                    saveCurrentNames();
                }
                
                currentCountSpan.textContent = String(bounded);
                renderPlayerInputs(bounded >= MIN_VALID_PLAYERS ? bounded : 0);
                updateControls(bounded);
                if (player1Hint) player1Hint.style.display = bounded > 0 ? '' : 'none';
                validateForm();
            }
            
            function saveCurrentNames() {
                const inputs = playerInputsContainer.querySelectorAll('input');
                inputs.forEach((input, index) => {
                    const playerNumber = index + 1;
                    playerNames.set(playerNumber, input.value);
                });
            }

            function normalizeForCompare(name) {
                return (name || '')
                    .toLocaleLowerCase()
                    .replace(/\s+/g, ' ')
                    .trim();
            }

            function sanitizeName(raw) {
                const trimmed = (raw || '').trim();
                // Collapse internal whitespace
                const collapsed = trimmed.replace(/\s+/g, ' ');
                // Allow letters, numbers, spaces, hyphen, underscore, apostrophe, period
                const cleaned = collapsed.replace(/[^A-Za-z0-9 _\-'.]/g, '');
                return cleaned.slice(0, 24);
            }

            function isValidName(name) {
                return /^[A-Za-z0-9 _\-'.]{1,24}$/.test(name);
            }

            function validateForm() {
                const count = getPlayerCount();
                if (!createGameBtn) return;
                if (count < MIN_VALID_PLAYERS) {
                    createGameBtn.disabled = true;
                    return;
                }
                const inputs = playerInputsContainer.querySelectorAll('input');
                let allFilled = true;
                let invalidFound = false;
                const seen = new Set();
                let dupName = null;
                inputs.forEach((inp) => {
                    const raw = inp.value || '';
                    const val = raw.trim();
                    if (!val) { allFilled = false; return; }
                    const sanitized = sanitizeName(val);
                    if (!isValidName(sanitized)) invalidFound = true;
                    const key = normalizeForCompare(sanitized);
                    if (seen.has(key) && !dupName) dupName = sanitized;
                    seen.add(key);
                });
                const err = document.getElementById(namesErrorId);
                if (err) {
                    if (!allFilled) err.textContent = '';
                    else if (invalidFound) err.textContent = 'Names may use letters, numbers, spaces, - _ \'. .';
                    else if (dupName) err.textContent = 'Duplicate names are not allowed.';
                    else err.textContent = '';
                }
                createGameBtn.disabled = !(allFilled && !invalidFound && !dupName);
            }

            function collectPlayerNames() {
                const inputs = playerInputsContainer.querySelectorAll('input');
                const names = [];
                inputs.forEach((inp) => {
                    const val = sanitizeName(inp.value || '');
                    if (val) names.push(val);
                });
                return names;
            }

            // Game ID generation is handled server-side in js/db.js (5-char code)

            async function handleCreateGame() {
                const count = getPlayerCount();
                if (count < MIN_VALID_PLAYERS) return;
                const players = collectPlayerNames();
                if (players.length !== count) return;
                // Validate again for duplicates and invalid
                const norm = players.map(normalizeForCompare);
                const hasDup = norm.length !== new Set(norm).size;
                const hasInvalid = players.some(n => !isValidName(n));
                if (hasDup || hasInvalid) {
                    const err = document.getElementById(namesErrorId);
                    if (err) err.textContent = hasInvalid ? 'Names may use letters, numbers, spaces, - _ \' .'
                        : 'Duplicate names are not allowed.';
                    return;
                }

                const gameName = (gameNameInput && gameNameInput.value || 'Secret Hitler Game').trim();
                const hostPasswordInput = document.getElementById('host-password-input');
                const hostPassword = hostPasswordInput ? (hostPasswordInput.value || '').trim() : '';
                const hostPasswordHash = hostPassword ? await crypto.subtle.digest('SHA-256', new TextEncoder().encode(hostPassword)).then(buf => Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('')).catch(() => null) : null;
                try {
                    const gameId = await createGame(gameName, players, hostPasswordHash);
                    try { localStorage.setItem('sh_currentGameId', gameId); } catch (_) {}
                    window.location.href = `lobby.html?game=${encodeURIComponent(gameId)}`;
                } catch (e) {
                    const err = document.getElementById(namesErrorId);
                    if (err) err.textContent = (e && e.message) ? String(e.message) : 'Failed to create game. Please check player names.';
                }
            }

            // Check for duplicate game parameters
            function checkForDuplicateGame() {
                const urlParams = new URLSearchParams(window.location.search);
                const isDuplicate = urlParams.get('duplicate') === 'true';
                
                if (isDuplicate) {
                    // Show duplicate notice
                    const duplicateNotice = document.getElementById('duplicate-notice');
                    if (duplicateNotice) {
                        duplicateNotice.style.display = 'block';
                    }
                    
                    const gameName = urlParams.get('gameName') || 'Secret Hitler Game';
                    const playerCount = parseInt(urlParams.get('playerCount') || '0', 10);
                    const playerNamesParam = urlParams.get('playerNames') || '';
                    
                    if (gameNameInput && gameName) {
                        gameNameInput.value = gameName;
                    }
                    
                    if (playerCount >= MIN_VALID_PLAYERS && playerCount <= MAX_PLAYERS) {
                        // Set player count
                        currentCountSpan.textContent = String(playerCount);
                        renderPlayerInputs(playerCount);
                        updateControls(playerCount);
                        
                        // Pre-fill player names
                        if (playerNamesParam) {
                            const names = playerNamesParam.split(',').map(name => name.trim());
                            names.forEach((name, index) => {
                                if (index < playerCount) {
                                    playerNames.set(index + 1, name);
                                }
                            });
                            
                            // Update the input fields with the names
                            const inputs = playerInputsContainer.querySelectorAll('input');
                            inputs.forEach((input, index) => {
                                if (index < names.length) {
                                    input.value = names[index];
                                }
                            });
                        }
                        
                        if (player1Hint) player1Hint.style.display = 'block';
                        validateForm();
                        
                        // Show success message
                        const statusContainer = document.getElementById('status-container');
                        if (statusContainer) {
                            const successMsg = document.createElement('div');
                            successMsg.className = 'status-message success';
                            successMsg.style.cssText = 'background: #10b981; color: white; padding: 12px; border-radius: 8px; margin: 16px 0; text-align: center; font-weight: 600;';
                            successMsg.textContent = `‚úÖ Successfully loaded ${playerCount} players from previous game!`;
                            statusContainer.appendChild(successMsg);
                            
                            // Remove message after 5 seconds
                            setTimeout(() => {
                                if (successMsg.parentNode) {
                                    successMsg.parentNode.removeChild(successMsg);
                                }
                            }, 5000);
                        }
                    }
                }
            }

            // Initialize starting state at 0 players
            setPlayerCount(0);
            
            // Check for duplicate game data on page load
            checkForDuplicateGame();

            // Controls: skip 1-4 when increasing from 0, and drop to 0 from 5 when decreasing
            if (increaseBtn) {
                increaseBtn.addEventListener('click', function() {
                    const current = getPlayerCount();
                    if (current === 0) {
                        setPlayerCount(MIN_VALID_PLAYERS);
                    } else if (current < MAX_PLAYERS) {
                        setPlayerCount(current + 1);
                    }
                });
            }

            if (decreaseBtn) {
                decreaseBtn.addEventListener('click', function() {
                    const current = getPlayerCount();
                    if (current <= MIN_VALID_PLAYERS) {
                        setPlayerCount(0);
                    } else {
                        setPlayerCount(current - 1);
                    }
                });
            }

            if (createGameBtn) {
                createGameBtn.addEventListener('click', function() {
                    handleCreateGame();
                });
            }
        });
    </script>
</body>
</html>


