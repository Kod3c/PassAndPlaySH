<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lobby - Secret Hitler</title>
    <link rel="stylesheet" href="../styles/app.css?v=dev">
    <meta name="theme-color" content="#101820">
    <style>
        .badge { display:inline-block; padding: 0.125rem 0.5rem; border: var(--border-medium) solid var(--propaganda-black); background: var(--off-white); font-weight: 700; font-size: var(--font-sm); border-radius: 999px; margin-left: 0.5rem; }
        .player-list-ul { list-style: none; padding-left: 0; margin: 0; display: grid; gap: var(--space-sm); }
        .player-list-item { display: flex; align-items: center; gap: 8px; padding: 0.375rem 0.5rem; background: #fff; border: var(--border-thin) dashed var(--propaganda-black); }
        .player-name { font-weight: 600; letter-spacing: 0.02em; }
        .lobby-actions { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; }
        .lobby-actions .btn { flex: 0 1 auto; }
        @media (max-width: 640px) {
            .lobby-actions { flex-direction: column; align-items: stretch; gap: 10px; }
            .lobby-actions .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo" onclick="window.location.href='../index.html'">
                        <span class="logo-icon">ðŸŽ­</span>
                        <div class="logo-text">
                            <h1>Secret Hitler</h1>
                            <p class="subtitle">Lobby</p>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main>
            <div class="container">
                <div class="card mb-4">
                    <div class="card-header">
                        <span class="card-icon">ðŸ•’</span>
                        <div>
                            <h2 class="card-title">Game Lobby</h2>
                            <p class="section-description">Waiting for players to join...</p>
                        </div>
                    </div>
                    <div class="card-content">
                        <div id="lobby-info" class="lobby-info"></div>
                        <div id="players-list" class="players-list mt-3"></div>

                        <div class="invite-section mt-3">
                            <div class="invite-row">
                                <input id="invite-link" class="form-control" type="text" readonly>
                                <button id="copy-invite-btn" class="btn btn-secondary">Copy Invite</button>
                            </div>
                            <small class="form-help">Share this link with other players to join the lobby.</small>
                        </div>

                        <div class="lobby-actions mt-4">
                            <button id="start-game-btn" class="btn btn-primary btn-lg" disabled>Start Game</button>
                            <button id="leave-lobby-btn" class="btn btn-outline btn-lg">ðŸšª Leave Lobby</button>
                            <button id="cancel-game-btn" class="btn btn-outline btn-lg">ðŸ›‘ Cancel Game</button>
                            <button class="btn btn-outline btn-lg" onclick="window.location.href='../index.html'">Back to Home</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="main-footer">
            <div class="container">
                <div class="footer-content">
                    <p class="footer-text">Built for offline play - no accounts or servers required</p>
                    <div class="footer-links">
                        <a href="../pages/rules.html" class="footer-link">ðŸ“– Rules</a>
                        <span class="footer-separator">â€¢</span>
                        <a href="../index.html" class="footer-link">ðŸŽ® Play</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script type="module">
        import { onGameSnapshot, getGame } from '../js/db.js';
        import { app } from '../js/firebase.js';
        import { getFirestore, doc, updateDoc, serverTimestamp, collection, query, where, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        (function() {
            const lobbyInfo = document.getElementById('lobby-info');
            const playersList = document.getElementById('players-list');
            const inviteInput = document.getElementById('invite-link');
            const copyInviteBtn = document.getElementById('copy-invite-btn');
            const startBtn = document.getElementById('start-game-btn');

            const db = getFirestore(app);
            const PRESENT_WINDOW_MS = 60 * 1000; // 60s
            const HEARTBEAT_INTERVAL_MS = 25 * 1000; // 25s
            let heartbeatTimer = null;

            async function ensureAuth() {
                const auth = getAuth(app);
                if (!auth.currentUser) await signInAnonymously(auth);
                return auth.currentUser;
            }

            async function autoClaimHost(gameId) {
                // Attempt to claim Player 1 (seat 1) if it has no uid yet
                try {
                    const authUser = await ensureAuth();
                    if (!authUser) return null;
                    const playersQ = query(collection(doc(db, 'games', gameId), 'players'), where('seat', '==', 1));
                    const snap = await getDocs(playersQ);
                    for (const d of snap.docs) {
                        const data = d.data() || {};
                        if (!data.uid) {
                            await updateDoc(d.ref, { uid: authUser.uid, lastSeen: serverTimestamp() });
                            try { localStorage.setItem(`sh_playerId_${gameId}`, d.id); } catch (_) {}
                            return d.id;
                        }
                    }
                } catch (_) {}
                return null;
            }

            function getGameIdFromUrl() {
                const params = new URLSearchParams(window.location.search);
                return params.get('game') || localStorage.getItem('sh_currentGameId') || '';
            }

            function render(game, players) {
                if (!game) {
                    lobbyInfo.innerHTML = '<p class="text-danger">No game found. Please create a game first.</p>';
                    startBtn.disabled = true;
                    return;
                }
                const joinUrl = window.location.origin + window.location.pathname.replace(/\/pages\/lobby\.html$/, '/pages/join.html') + '?game=' + encodeURIComponent(game.id);
                inviteInput.value = joinUrl;

                lobbyInfo.innerHTML = `
                    <div class="lobby-header">
                        <div class="lobby-meta">
                            <div><strong>Game:</strong> ${game.name || 'Secret Hitler Game'}</div>
                            <div><strong>Game ID:</strong> ${game.id}</div>
                            <div><strong>Players Expected:</strong> ${game.playerCount || (players ? players.length : 0)}</div>
                        </div>
                        <div class="lobby-status">
                            <span class="status-dot"></span>
                            <span>Waiting for players...</span>
                        </div>
                    </div>
                `;

                // Deduplicate by name, prefer docs with uid
                const nameToPlayer = new Map();
                (players || []).forEach((p) => {
                    const key = (p.name || '').toString().trim();
                    if (!key) return;
                    const existing = nameToPlayer.get(key);
                    if (!existing) {
                        nameToPlayer.set(key, p);
                    } else {
                        // Prefer the one with uid; if both have/no uid keep existing
                        if (!existing.uid && p.uid) nameToPlayer.set(key, p);
                    }
                });

                // Identify current player via saved playerId or current auth uid (make sure it exists before grouping)
                let savedPlayerId = null;
                try { savedPlayerId = localStorage.getItem(`sh_playerId_${game.id}`); } catch (_) { savedPlayerId = null; }
                const authUser = getAuth(app).currentUser;
                const currentUid = authUser ? authUser.uid : null;
                function isYou(playerDoc) {
                    return (savedPlayerId && playerDoc.id === savedPlayerId) || (currentUid && playerDoc.uid === currentUid);
                }

                const now = Date.now();
                const present = [];
                const notPresent = [];
                for (const [name, p] of nameToPlayer.entries()) {
                    const lastSeen = p.lastSeen && p.lastSeen.toDate ? p.lastSeen.toDate().getTime() : 0;
                    const isPresent = Boolean(p.uid) && (lastSeen > 0) && (now - lastSeen <= PRESENT_WINDOW_MS);
                    const effectivePresent = isYou(p) || isPresent;
                    (effectivePresent ? present : notPresent).push({ name, p });
                }

                // Sort alphabetically by name within groups
                present.sort((a, b) => a.name.localeCompare(b.name));
                notPresent.sort((a, b) => a.name.localeCompare(b.name));

                // Move your player to the top of the present list
                const youIndex = present.findIndex(item => isYou(item.p));
                if (youIndex > 0) {
                    const [youItem] = present.splice(youIndex, 1);
                    present.unshift(youItem);
                }

                function renderList(items, status) {
                    const ul = document.createElement('ul');
                    ul.className = 'player-list-ul';
                    items.forEach((item) => {
                        const li = document.createElement('li');
                        li.className = 'player-list-item';
                        const dotColor = status === 'present' ? '#22c55e' : '#9ca3af';
                        const label = isYou(item.p) ? `${item.name} - You` : item.name;
                        li.innerHTML = `
                            <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${dotColor};margin-right:8px;"></span>
                            <span class="player-name">${label}</span>
                        `;
                        ul.appendChild(li);
                    });
                    return ul;
                }

                const container = document.createElement('div');
                container.style.display = 'flex';
                container.style.gap = '16px';
                container.style.alignItems = 'flex-start';
                container.style.flexWrap = 'wrap';

                function column(title, count, ul) {
                    const col = document.createElement('div');
                    col.style.flex = '1 1 280px';
                    col.style.minWidth = '260px';
                    col.className = 'card subtle';
                    const header = document.createElement('div');
                    header.className = 'card-header';
                    header.innerHTML = `<div><h3 class="card-title">${title} <span class="badge">${count}</span></h3></div>`;
                    const body = document.createElement('div');
                    body.className = 'card-content';
                    body.appendChild(ul);
                    col.appendChild(header);
                    col.appendChild(body);
                    return col;
                }

                const presentCol = column('Present', present.length, renderList(present, 'present'));
                const awayCol = column('Not Present', notPresent.length, renderList(notPresent, 'away'));

                const allPresent = notPresent.length === 0;

                playersList.innerHTML = '';
                if (allPresent) {
                    presentCol.style.flex = '1 1 100%';
                    presentCol.style.minWidth = '100%';
                    container.appendChild(presentCol);
                } else {
                    container.appendChild(presentCol);
                    container.appendChild(awayCol);
                }
                playersList.appendChild(container);

                // For now, enable start only for host and keep disabled pending full presence logic
                const isHost = true; // This device created the game in create.html
                startBtn.disabled = !isHost;
            }

            function copyInvite() {
                inviteInput.select();
                try {
                    document.execCommand('copy');
                    copyInviteBtn.textContent = 'Copied!';
                    setTimeout(() => { copyInviteBtn.textContent = 'Copy Invite'; }, 1500);
                } catch (e) {
                    console.warn('Copy failed, select manually');
                }
            }

            async function cancelGame(gameId) {
                if (!gameId) return;
                const confirmed = window.confirm('Cancel this game? Players will be returned to home.');
                if (!confirmed) return;
                try {
                    await ensureAuth();
                    const gameRef = doc(db, 'games', gameId);
                    await setDoc(gameRef, { state: 'cancelled', updatedAt: serverTimestamp(), expireAt: new Date() }, { merge: true });
                } catch (e) {
                    console.error('Failed to cancel game', e);
                }
                try { localStorage.removeItem('sh_currentGameId'); } catch (_) {}
                try { localStorage.removeItem(`sh_playerId_${gameId}`); } catch (_) {}
                window.location.href = '../index.html';
            }

            async function leaveLobby(gameId) {
                if (!gameId) return;
                const confirmed = window.confirm('Leave this lobby?');
                if (!confirmed) return;
                try {
                    // Stop heartbeat updates
                    if (heartbeatTimer) {
                        clearInterval(heartbeatTimer);
                        heartbeatTimer = null;
                    }

                    // Clear uid/lastSeen so this seat becomes available
                    const playerIdKey = `sh_playerId_${gameId}`;
                    let playerId = null;
                    try { playerId = localStorage.getItem(playerIdKey); } catch (_) { playerId = null; }
                    if (playerId) {
                        try { await ensureAuth(); } catch (_) {}
                        const playerRef = doc(db, 'games', gameId, 'players', playerId);
                        try {
                            await updateDoc(playerRef, { uid: null, lastSeen: null });
                        } catch (e) {
                            console.warn('Failed to clear player uid/lastSeen', e);
                        }
                    }
                } finally {
                    try { localStorage.removeItem(`sh_playerId_${gameId}`); } catch (_) {}
                    window.location.href = '../index.html';
                }
            }

            async function startHeartbeat(gameId) {
                try { await ensureAuth(); } catch (_) {}
                const playerIdKey = `sh_playerId_${gameId}`;
                let playerId = null;
                try { playerId = localStorage.getItem(playerIdKey); } catch (_) { playerId = null; }
                if (!playerId) {
                    // Try to auto-claim host (Player 1) if uid missing
                    playerId = await autoClaimHost(gameId);
                }
                if (!playerId) return; // nothing to heartbeat yet

                const playerRef = doc(db, 'games', gameId, 'players', playerId);

                async function beat() {
                    try { await updateDoc(playerRef, { lastSeen: serverTimestamp() }); } catch (_) {}
                }

                // initial beat on load/visibility
                beat();

                if (heartbeatTimer) clearInterval(heartbeatTimer);
                heartbeatTimer = setInterval(beat, HEARTBEAT_INTERVAL_MS);

                document.addEventListener('visibilitychange', function() {
                    if (document.visibilityState === 'visible') beat();
                });
                window.addEventListener('beforeunload', function() {
                    // best-effort; may not complete
                    beat();
                });
            }

            document.addEventListener('DOMContentLoaded', async function() {
                const gameId = getGameIdFromUrl();
                if (!gameId) {
                    render(null);
                    return;
                }
                const initial = await getGame(gameId);
                render(initial, []);
                onGameSnapshot(gameId, ({ game, players }) => render(game, players));
                startHeartbeat(gameId);
                copyInviteBtn.addEventListener('click', copyInvite);
                startBtn.addEventListener('click', function() {
                    window.location.href = '../index.html';
                });
                const cancelBtn = document.getElementById('cancel-game-btn');
                if (cancelBtn) cancelBtn.addEventListener('click', function() { cancelGame(gameId); });
                const leaveBtn = document.getElementById('leave-lobby-btn');
                if (leaveBtn) leaveBtn.addEventListener('click', function() { leaveLobby(gameId); });
            });
        })();
    </script>
</body>
</html>
