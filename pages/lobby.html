<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lobby - Secret Hitler</title>
    <link rel="stylesheet" href="../styles/app.css?v=dev">
    <meta name="theme-color" content="#101820">
    <style>
        .badge { display:inline-block; padding: 0.125rem 0.5rem; border: var(--border-medium) solid var(--propaganda-black); background: var(--off-white); font-weight: 700; font-size: var(--font-sm); border-radius: 999px; margin-left: 0.5rem; }
        .player-list-ul { list-style: none; padding-left: 0; margin: 0; display: grid; gap: var(--space-sm); }
        .player-list-item { display: flex; align-items: center; gap: 8px; padding: 0.375rem 0.5rem; background: #fff; border: var(--border-thin) dashed var(--propaganda-black); }
        .player-name { font-weight: 600; letter-spacing: 0.02em; }
        .lobby-actions { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; }
        .lobby-actions .btn { flex: 0 1 auto; }
        @media (max-width: 640px) {
            .lobby-actions { flex-direction: column; align-items: stretch; gap: 10px; }
            .lobby-actions .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo" onclick="window.location.href='../index.html'">
                        <span class="logo-icon">ðŸŽ­</span>
                        <div class="logo-text">
                            <h1>Secret Hitler</h1>
                            <p class="subtitle">Lobby</p>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main>
            <div class="container">
                <div class="card mb-4">
                    <div class="card-header">
                        <span class="card-icon">ðŸ•’</span>
                        <div>
                            <h2 class="card-title">Game Lobby</h2>
                            <p class="section-description">Waiting for players to join...</p>
                        </div>
                    </div>
                    <div class="card-content">
                        <div id="lobby-info" class="lobby-info"></div>
                        <div id="players-list" class="players-list mt-3"></div>

                        <div class="invite-section mt-3">
                            <div class="invite-row">
                                <input id="invite-link" class="form-control" type="text" readonly>
                                <button id="copy-invite-btn" class="btn btn-secondary">Copy Invite</button>
                            </div>
                            <small class="form-help">Share this link with other players to join the lobby.</small>
                        </div>

                        <div class="lobby-actions mt-4">
                            <button id="start-game-btn" class="btn btn-primary btn-lg" disabled>Start Game</button>
                            <button id="leave-lobby-btn" class="btn btn-outline btn-lg">ðŸšª Leave Lobby</button>
                            <button id="cancel-game-btn" class="btn btn-outline btn-lg">ðŸ›‘ Cancel Game</button>
                            <button class="btn btn-outline btn-lg" onclick="window.location.href='../index.html'">Back to Home</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="main-footer">
            <div class="container">
                <div class="footer-content">
                    <p class="footer-text">Built for offline play - no accounts or servers required</p>
                    <div class="footer-links">
                        <a href="../pages/rules.html" class="footer-link">ðŸ“– Rules</a>
                        <span class="footer-separator">â€¢</span>
                        <a href="../index.html" class="footer-link">ðŸŽ® Play</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script type="module">
        import { onGameSnapshot, getGame } from '../js/db.js';
        import { app } from '../js/firebase.js';
        import { getFirestore, doc, updateDoc, serverTimestamp, collection, query, where, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        (function() {
            const lobbyInfo = document.getElementById('lobby-info');
            const playersList = document.getElementById('players-list');
            const inviteInput = document.getElementById('invite-link');
            const copyInviteBtn = document.getElementById('copy-invite-btn');
            const startBtn = document.getElementById('start-game-btn');

            const db = getFirestore(app);
            const PRESENT_WINDOW_MS = 60 * 1000; // 60s
            const HEARTBEAT_INTERVAL_MS = 25 * 1000; // 25s
            let heartbeatTimer = null;
            let removalHandled = false;

            function handleGameRemoved() {
                if (removalHandled) return;
                removalHandled = true;
                try { alert('This game is no longer available. Returning to home.'); } catch (_) {}
                window.location.href = '../index.html';
            }

            async function ensureAuth() {
                const auth = getAuth(app);
                if (!auth.currentUser) await signInAnonymously(auth);
                return auth.currentUser;
            }

            async function autoClaimHost(gameId) {
                // Attempt to claim Player 1 (seat 1) if it has no uid yet
                try {
                    const authUser = await ensureAuth();
                    if (!authUser) return null;
                    const playersQ = query(collection(doc(db, 'games', gameId), 'players'), where('seat', '==', 1));
                    const snap = await getDocs(playersQ);
                    for (const d of snap.docs) {
                        const data = d.data() || {};
                        if (!data.uid) {
                            await updateDoc(d.ref, { uid: authUser.uid, lastSeen: serverTimestamp() });
                            try { sessionStorage.setItem(`sh_playerId_${gameId}`, d.id); } catch (_) {}
                            return d.id;
                        }
                    }
                } catch (_) {}
                return null;
            }

            function getGameIdFromUrl() {
                const params = new URLSearchParams(window.location.search);
                return params.get('game') || localStorage.getItem('sh_currentGameId') || '';
            }

            function render(game, players) {
                if (!game) { handleGameRemoved(); return; }
                const joinUrl = window.location.origin + window.location.pathname.replace(/\/pages\/lobby\.html$/, '/pages/join.html') + '?game=' + encodeURIComponent(game.id);
                inviteInput.value = joinUrl;

                // Safely render lobby info without injecting user strings as HTML
                lobbyInfo.innerHTML = '';
                const headerDiv = document.createElement('div');
                headerDiv.className = 'lobby-header';

                const metaDiv = document.createElement('div');
                metaDiv.className = 'lobby-meta';
                const gameRow = document.createElement('div');
                const gameStrong = document.createElement('strong');
                gameStrong.textContent = 'Game:';
                gameRow.appendChild(gameStrong);
                gameRow.appendChild(document.createTextNode(' '));
                const gameNameSpan = document.createElement('span');
                gameNameSpan.textContent = game.name || 'Secret Hitler Game';
                gameRow.appendChild(gameNameSpan);

                const idRow = document.createElement('div');
                const idStrong = document.createElement('strong');
                idStrong.textContent = 'Game ID:';
                idRow.appendChild(idStrong);
                idRow.appendChild(document.createTextNode(' ' + (game.id || '')));

                const countRow = document.createElement('div');
                const countStrong = document.createElement('strong');
                countStrong.textContent = 'Players Expected:';
                countRow.appendChild(countStrong);
                const expected = (typeof game.playerCount === 'number' && game.playerCount > 0)
                    ? game.playerCount
                    : (players ? players.length : 0);
                countRow.appendChild(document.createTextNode(' ' + expected));

                metaDiv.appendChild(gameRow);
                metaDiv.appendChild(idRow);
                metaDiv.appendChild(countRow);

                const statusDiv = document.createElement('div');
                statusDiv.className = 'lobby-status';
                const statusDot = document.createElement('span');
                statusDot.className = 'status-dot';
                const statusText = document.createElement('span');
                statusText.textContent = 'Waiting for players...';
                statusDiv.appendChild(statusDot);
                statusDiv.appendChild(statusText);

                headerDiv.appendChild(metaDiv);
                headerDiv.appendChild(statusDiv);
                lobbyInfo.appendChild(headerDiv);

                // Identify current player via saved playerId or current auth uid (use raw players list)
                let savedPlayerId = null;
                try { savedPlayerId = sessionStorage.getItem(`sh_playerId_${game.id}`); } catch (_) { savedPlayerId = null; }
                const authUser = getAuth(app).currentUser;
                const currentUid = authUser ? authUser.uid : null;
                let youPlayerId = null;
                if (savedPlayerId && (players || []).some(pl => pl && pl.id === savedPlayerId)) {
                    youPlayerId = savedPlayerId;
                } else if (currentUid) {
                    const match = (players || []).find(pl => pl && pl.uid === currentUid);
                    if (match) youPlayerId = match.id;
                }
                function isYou(playerDoc) {
                    return Boolean(playerDoc && youPlayerId && playerDoc.id === youPlayerId);
                }

                // Deduplicate by name with smarter preference: you > present > has uid > newest lastSeen
                const now = Date.now();
                function getLastSeenMs(doc) {
                    try { return doc && doc.lastSeen && doc.lastSeen.toDate ? doc.lastSeen.toDate().getTime() : 0; } catch (_) { return 0; }
                }
                function isDocPresent(doc) {
                    const ms = getLastSeenMs(doc);
                    return Boolean(doc && doc.uid) && ms > 0 && (now - ms <= PRESENT_WINDOW_MS);
                }
                function pickPreferred(existing, candidate) {
                    if (!existing) return candidate;
                    if (!candidate) return existing;
                    if (isYou(candidate)) return candidate;
                    if (isYou(existing)) return existing;
                    const ePresent = isDocPresent(existing);
                    const cPresent = isDocPresent(candidate);
                    if (cPresent && !ePresent) return candidate;
                    if (!cPresent && ePresent) return existing;
                    if (candidate.uid && !existing.uid) return candidate;
                    if (!candidate.uid && existing.uid) return existing;
                    const eLast = getLastSeenMs(existing);
                    const cLast = getLastSeenMs(candidate);
                    if (cLast > eLast) return candidate;
                    return existing;
                }
                const nameToPlayer = new Map();
                (players || []).forEach((p) => {
                    const key = (p.name || '').toString().trim();
                    if (!key) return;
                    const existing = nameToPlayer.get(key);
                    nameToPlayer.set(key, pickPreferred(existing, p));
                });

                const present = [];
                const notPresent = [];
                for (const [name, p] of nameToPlayer.entries()) {
                    const lastSeen = p.lastSeen && p.lastSeen.toDate ? p.lastSeen.toDate().getTime() : 0;
                    const isPresent = Boolean(p.uid) && (lastSeen > 0) && (now - lastSeen <= PRESENT_WINDOW_MS);
                    const effectivePresent = (youPlayerId && p.id === youPlayerId) || isPresent;
                    (effectivePresent ? present : notPresent).push({ name, p });
                }

                // Sort alphabetically by name within groups
                present.sort((a, b) => a.name.localeCompare(b.name));
                notPresent.sort((a, b) => a.name.localeCompare(b.name));

                // Move your player to the top of the present list
                const youIndex = present.findIndex(item => isYou(item.p));
                if (youIndex > 0) {
                    const [youItem] = present.splice(youIndex, 1);
                    present.unshift(youItem);
                }

                function renderList(items, status) {
                    const ul = document.createElement('ul');
                    ul.className = 'player-list-ul';
                    items.forEach((item) => {
                        const li = document.createElement('li');
                        li.className = 'player-list-item';
                        const dotColor = status === 'present' ? '#22c55e' : '#9ca3af';
                        const dot = document.createElement('span');
                        dot.style.display = 'inline-block';
                        dot.style.width = '10px';
                        dot.style.height = '10px';
                        dot.style.borderRadius = '50%';
                        dot.style.background = dotColor;
                        dot.style.marginRight = '8px';
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'player-name';
                        nameSpan.textContent = isYou(item.p) ? `${item.name} - You` : item.name;
                        li.appendChild(dot);
                        li.appendChild(nameSpan);
                        ul.appendChild(li);
                    });
                    return ul;
                }

                const container = document.createElement('div');
                container.style.display = 'flex';
                container.style.gap = '16px';
                container.style.alignItems = 'flex-start';
                container.style.flexWrap = 'wrap';

                function column(title, count, ul) {
                    const col = document.createElement('div');
                    col.style.flex = '1 1 280px';
                    col.style.minWidth = '260px';
                    col.className = 'card subtle';
                    const header = document.createElement('div');
                    header.className = 'card-header';
                    const titleWrap = document.createElement('div');
                    const h3 = document.createElement('h3');
                    h3.className = 'card-title';
                    h3.textContent = `${title} `;
                    const badge = document.createElement('span');
                    badge.className = 'badge';
                    badge.textContent = String(count);
                    h3.appendChild(badge);
                    titleWrap.appendChild(h3);
                    header.appendChild(titleWrap);
                    const body = document.createElement('div');
                    body.className = 'card-content';
                    body.appendChild(ul);
                    col.appendChild(header);
                    col.appendChild(body);
                    return col;
                }

                const presentCol = column('Present', present.length, renderList(present, 'present'));
                const awayCol = column('Not Present', notPresent.length, renderList(notPresent, 'away'));

                // Determine if all expected players are present
                const expectedCount = (typeof game.playerCount === 'number' && game.playerCount > 0)
                    ? game.playerCount
                    : nameToPlayer.size;
                const allPresent = present.length >= expectedCount && notPresent.length === 0;

                playersList.innerHTML = '';
                if (allPresent) {
                    presentCol.style.flex = '1 1 100%';
                    presentCol.style.minWidth = '100%';
                    container.appendChild(presentCol);
                } else {
                    container.appendChild(presentCol);
                    container.appendChild(awayCol);
                }
                playersList.appendChild(container);

                // Enable start only if current user is host (seat 1) AND all players are present
                let youPlayer = null;
                if (youPlayerId) {
                    youPlayer = (players || []).find(pl => pl && pl.id === youPlayerId) || null;
                }
                const isHost = Boolean(youPlayer && youPlayer.seat === 1);
                startBtn.disabled = !(isHost && allPresent);
                const cancelBtnEl = document.getElementById('cancel-game-btn');
                if (cancelBtnEl) cancelBtnEl.style.display = isHost ? '' : 'none';
            }

            function copyInvite() {
                inviteInput.select();
                try {
                    document.execCommand('copy');
                    copyInviteBtn.textContent = 'Copied!';
                    setTimeout(() => { copyInviteBtn.textContent = 'Copy Invite'; }, 1500);
                } catch (e) {
                    console.warn('Copy failed, select manually');
                }
            }

            async function cancelGame(gameId) {
                if (!gameId) return;
                const confirmed = window.confirm('Cancel this game? Players will be returned to home.');
                if (!confirmed) return;
                try {
                    await ensureAuth();
                    const gameRef = doc(db, 'games', gameId);
                    await setDoc(gameRef, { state: 'cancelled', updatedAt: serverTimestamp(), expireAt: new Date() }, { merge: true });
                } catch (e) {
                    console.error('Failed to cancel game', e);
                }
                try { localStorage.removeItem('sh_currentGameId'); } catch (_) {}
                try { sessionStorage.removeItem(`sh_playerId_${gameId}`); } catch (_) {}
                window.location.href = '../index.html';
            }

            async function leaveLobby(gameId) {
                if (!gameId) return;
                const confirmed = window.confirm('Leave this lobby?');
                if (!confirmed) return;
                try {
                    // Stop heartbeat updates
                    if (heartbeatTimer) {
                        clearInterval(heartbeatTimer);
                        heartbeatTimer = null;
                    }

                    // Clear uid/lastSeen so this seat becomes available
                    const playerIdKey = `sh_playerId_${gameId}`;
                    let playerId = null;
                    try { playerId = sessionStorage.getItem(playerIdKey); } catch (_) { playerId = null; }
                    if (playerId) {
                        try { await ensureAuth(); } catch (_) {}
                        const playerRef = doc(db, 'games', gameId, 'players', playerId);
                        try {
                            await updateDoc(playerRef, { uid: null, lastSeen: null });
                        } catch (e) {
                            console.warn('Failed to clear player uid/lastSeen', e);
                        }
                    }
                } finally {
                    try { sessionStorage.removeItem(`sh_playerId_${gameId}`); } catch (_) {}
                    window.location.href = '../index.html';
                }
            }

            async function startHeartbeat(gameId) {
                try { await ensureAuth(); } catch (_) {}
                const playerIdKey = `sh_playerId_${gameId}`;
                let playerId = null;
                try { playerId = sessionStorage.getItem(playerIdKey); } catch (_) { playerId = null; }
                if (!playerId) {
                    // Try to auto-claim host (Player 1) if uid missing
                    playerId = await autoClaimHost(gameId);
                }
                if (!playerId) {
                    // Fallback: find existing claimed player by current uid
                    try {
                        const authUser = getAuth(app).currentUser;
                        const uid = authUser ? authUser.uid : null;
                        if (uid) {
                            const playersQ = query(collection(doc(db, 'games', gameId), 'players'), where('uid', '==', uid));
                            const snap = await getDocs(playersQ);
                            if (!snap.empty) {
                                const d = snap.docs[0];
                                playerId = d.id;
                                try { sessionStorage.setItem(playerIdKey, playerId); } catch (_) {}
                            }
                        }
                    } catch (_) {}
                }
                if (!playerId) return; // nothing to heartbeat yet

                const playerRef = doc(db, 'games', gameId, 'players', playerId);

                async function beat() {
                    try { await updateDoc(playerRef, { lastSeen: serverTimestamp() }); } catch (_) {}
                }

                // initial beat on load/visibility
                beat();

                if (heartbeatTimer) clearInterval(heartbeatTimer);
                heartbeatTimer = setInterval(beat, HEARTBEAT_INTERVAL_MS);

                document.addEventListener('visibilitychange', function() {
                    if (document.visibilityState === 'visible') beat();
                });
                window.addEventListener('beforeunload', function() {
                    // best-effort; may not complete
                    beat();
                });
            }

            document.addEventListener('DOMContentLoaded', async function() {
                const gameId = getGameIdFromUrl();
                if (!gameId) { window.location.href = '../index.html'; return; }
                const initial = await getGame(gameId);
                if (!initial) { handleGameRemoved(); return; }
                render(initial, []);
                onGameSnapshot(gameId, ({ game, players }) => {
                    if (!game || (game && game.state === 'cancelled')) { handleGameRemoved(); return; }
                    render(game, players);
                });
                startHeartbeat(gameId);
                copyInviteBtn.addEventListener('click', copyInvite);
                startBtn.addEventListener('click', function() {
                    window.location.href = '../index.html';
                });
                const cancelBtn = document.getElementById('cancel-game-btn');
                if (cancelBtn) cancelBtn.addEventListener('click', function() { cancelGame(gameId); });
                const leaveBtn = document.getElementById('leave-lobby-btn');
                if (leaveBtn) leaveBtn.addEventListener('click', function() { leaveLobby(gameId); });
            });
        })();
    </script>
</body>
</html>
